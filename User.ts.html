<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>User.ts - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Interfaces</li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="ChangeCourse.html">ChangeCourse</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="ChangeModuleItem.html">ChangeModuleItem</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="ChangeString.html">ChangeString</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="ChangeStudents.html">ChangeStudents</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="ChangeSubmodule.html">ChangeSubmodule</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="ChangeTeacher.html">ChangeTeacher</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="DeleteUser.html">DeleteUser</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="GeneralCourse.html">GeneralCourse</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="GeneralModule.html">GeneralModule</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="LoginUser.html">LoginUser</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="RegisterFile.html">RegisterFile</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="RegisterModuleItem.html">RegisterModuleItem</a></span></li><li class="nav-heading"><span class="nav-item-type type-interface">I</span><span class="nav-item-name"><a href="RegisterUser.html">RegisterUser</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#addCourse">addCourse</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#addDownloadFile">addDownloadFile</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#addStudent">addStudent</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#addSubmodule">addSubmodule</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#addTeacher">addTeacher</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#changeCourse">changeCourse</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#changeDescription">changeDescription</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#changeModuleItem">changeModuleItem</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#changeName">changeName</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#changeUserPassword">changeUserPassword</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#checkAdministrator">checkAdministrator</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#checkAdministratorOrModuleTeacher">checkAdministratorOrModuleTeacher</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#checkAdministratorOrOwnID">checkAdministratorOrOwnID</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#checkAdministratorOrOwnUsername">checkAdministratorOrOwnUsername</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createCourse">createCourse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createFile">createFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createLoginJwt">createLoginJwt</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createModule">createModule</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createModuleItem">createModuleItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createUser">createUser</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createUserDetail">createUserDetail</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteAllModuleItems">deleteAllModuleItems</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteCourse">deleteCourse</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteDownloadFile">deleteDownloadFile</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteGradeForStudent">deleteGradeForStudent</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteModule">deleteModule</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteModuleItem">deleteModuleItem</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteObjects">deleteObjects</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteStudent">deleteStudent</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteSubmodule">deleteSubmodule</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteTeacher">deleteTeacher</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteTimeTableEntriesModule">deleteTimeTableEntriesModule</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteUser">deleteUser</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getAllUsers">getAllUsers</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getGradesForModule">getGradesForModule</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getGradesForStudent">getGradesForStudent</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getObjects">getObjects</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getOneObject">getOneObject</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getTimeTableEntriesCourse">getTimeTableEntriesCourse</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getTimeTableEntriesModule">getTimeTableEntriesModule</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getTimeTableEntriesPerson">getTimeTableEntriesPerson</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#insertGradeForStudent">insertGradeForStudent</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#insertTimetableEntry">insertTimetableEntry</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#loginUser">loginUser</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#registerCourse">registerCourse</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#registerFile">registerFile</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#registerModule">registerModule</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#registerUser">registerUser</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#saveNewCourse">saveNewCourse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#saveNewFile">saveNewFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#saveNewModule">saveNewModule</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#saveNewModuleItem">saveNewModuleItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#saveNewUser">saveNewUser</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#saveObject">saveObject</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#selectAllModuleItems">selectAllModuleItems</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#selectCourse">selectCourse</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#selectModule">selectModule</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#selectModuleItem">selectModuleItem</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">User.ts</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { Request, Response } from 'express';
import { getConnection, getRepository, Repository } from 'typeorm';
import { hash, verify } from 'argon2';
import { sign } from 'jsonwebtoken';
import User from '../entity/User';
import UserDetail from '../entity/UserDetail';
import { getOneObject, deleteObjects, saveObject } from './Manager';

/**
 * Representation of the incoming data for removing a user
 * @interface
 */
interface DeleteUser {
  username: string;
}

/**
 * Representation of the incoming data of a user login
 * @interface
 */
interface LoginUser extends DeleteUser {
  password: string;
}

/**
 * Representation of the incoming data of a new user
 * @interface
 */
interface RegisterUser extends LoginUser {
  role: string;
  fullname: string;
  address: string;
  matriculationNumber: string;
  mail: string;
}

/**
 * @async
 * Creates a new User with the given data
 * @param {RegisterUser} data - Data of the new user
 * @returns {Promise&lt;User>}
 */
const createUser = async (data: RegisterUser): Promise&lt;User> => {
  const newUser = new User();
  newUser.username = data.username;
  newUser.password = await hash(data.password);
  switch (data.role) {
    case 'teacher':
      newUser.isTeacher = true; break;
    case 'administrator':
      newUser.isAdministrator = true; break;
    default:
      break;
  }
  return newUser;
};
/**
 * Creates a new UserDetail with the given data
 * @param {RegisterUser} data - Details of the new User
 * @param {User} newUser - Already created User-Object
 * @returns {UserDetail}
 */
const createUserDetail = (data: RegisterUser, newUser: User): UserDetail => {
  const newUserDetail = new UserDetail();
  newUserDetail.userId = newUser;
  newUserDetail.fullname = data.fullname;
  newUserDetail.address = data.address;
  newUserDetail.matriculationNumber = data.matriculationNumber;
  newUserDetail.mail = data.mail;
  return newUserDetail;
};

/**
 * @async
 * Saves the create User- and UserDetail-Object inside the database.
 * No data is stored, if one of the objects could not be stored,
 * in this case a response with HTTP-Status 403 will be formed.
 * Forms a response with HTTP-Code 200 if the objects could be stored.
 * @param {User} newUser - New User to store
 * @param {UserDetail} newUserDetail - Details of the new user
 * @param {Response} res - Response object for sending the response
 */
const saveNewUser = async (
  newUser: User,
  newUserDetail: UserDetail,
  res: Response,
): Promise&lt;void> => {
  const queryRunner = getConnection().createQueryRunner();
  await queryRunner.startTransaction();
  try {
    await queryRunner.manager.save(newUser);
    await queryRunner.manager.save(newUserDetail);
    await queryRunner.commitTransaction();

    res.sendStatus(200);
  } catch (_err) {
    await queryRunner.rollbackTransaction();
    res.sendStatus(500);
  }
};

/**
 * @async
 * Registers a new User with the data given by the HTTP-Request
 * @param {Request} req - Holds the data from the HTTP-Request
 * @param {Response} res - Used to form the response
 */
export const registerUser = async (req: Request, res: Response) => {
  try {
    const data: RegisterUser = req.body;
    const newUser: User = await createUser(data);
    const newUserDetail: UserDetail = createUserDetail(data, newUser);
    saveNewUser(newUser, newUserDetail, res);
  } catch (_err) {
    res.sendStatus(500);
  }
};

/**
 * @async
 * Create a signed JWT with the found user and their user-details
 * @param {User} user - Selected user
 * @param {UserDetail} userDetails - Details of the selected user
 * @returns {Promise&lt;String>} Signed JWT as string
 */
const createLoginJwt = async (user: User, userDetails: UserDetail): Promise&lt;string> => {
  let role = 'student';
  if (user.isAdministrator) {
    role = 'administrator';
  } else if (user.isTeacher) {
    role = 'teacher';
  }
  return sign({
    id: user.id,
    username: user.username,
    fullName: userDetails.fullname,
    role,
    exp: Math.floor(Date.now() / 1000) + (12 * 60 * 60),
  }, process.env.jwtSignatureKey);
};
/**
 * @async
 * Tries to login a user with the given credentials
 * @param {Request} req - Received request object
 * @param {Response} res - Received response object
 * @returns HTTP-Status 200 and JWT
 * @throws HTTP-Status 403 and "Wrong username or password" - Invalid username or wrong password
 */
export const loginUser = async (req: Request, res: Response): Promise&lt;void> => {
  try {
    const data: LoginUser = req.body;
    const user: any = await getOneObject({ where: { username: data.username } }, User);
    if (!await verify(user.password, data.password)) {
      throw new Error();
    }
    const userDetails: any = await getOneObject({ where: { userId: user } }, UserDetail);
    res.status(200).send(await createLoginJwt(user, userDetails));
  } catch (_err) {
    res.status(403).send('Wrong username or password');
  }
};

/**
 * @async
 * Deletes the user with the given username and id
 * @param {Request} req - Received request object
 * @param {Response} res - Received response object
 */
export const deleteUser = async (req: Request, res: Response) => {
  try {
    const data: DeleteUser = req.body;
    const user: any = await getOneObject({ where: { username: data.username } }, User);
    await deleteObjects({ userId: user }, UserDetail);
    await deleteObjects(user, User);
    res.status(200).send('The user has been deleted');
  } catch (_err) {
    res.status(500).send('The user could not be deleted');
  }
};

/**
 * @async
 * Changes the password of a user
 * @param {Request} req - Received request object
 * @param {Response} res - Received response object
 */
export const changeUserPassword = async (req: Request, res: Response) => {
  try {
    const data: LoginUser = req.body;
    const user: any = await getOneObject({ where: { username: data.username } }, User);
    user.password = await hash(data.password);
    await saveObject(user, User);
    res.status(200).send('The password has been changed');
  } catch (_err) {
    res.status(500).send('Password could not be changed');
  }
};

/**
 * @async
 * Get all users from the repository
 * @param {Request} req - Received request object
 * @param {Response} res - Received response object
 */
export const getAllUsers = async (req: Request, res: Response) => {
  try {
    const users: UserDetail[] = await getRepository(UserDetail)
      .createQueryBuilder('')
      .select([
        'UserDetail.id',
        'UserDetail.fullname',
        'UserDetail.address',
        'UserDetail.matriculationNumber',
        'UserDetail.mail',
        'UserDetail.userId',
        'User.id',
        'User.username',
        'User.isTeacher',
        'User.isAdministrator',
      ])
      .leftJoin('UserDetail.userId', 'User')
      .getMany();
    res.status(200).send(users);
  } catch (_err) {
    res.status(500).send('The users could not be retrieved');
  }
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Fri Mar 04 2022 11:05:19 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
